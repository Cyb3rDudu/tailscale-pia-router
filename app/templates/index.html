<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailscale PIA Router</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media'
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900" x-data="app()" x-init="init()">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Tailscale PIA Router</h1>
                    <a href="/settings" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Settings</a>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- VPN Connections Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">VPN Connections</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="vpnStatus.active_count > 0 ? 'bg-green-500' : 'bg-gray-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="vpnStatus.active_count > 0 ? `${vpnStatus.active_count} active connection${vpnStatus.active_count > 1 ? 's' : ''}` : 'No active connections'"></span>
                        </div>
                        <template x-if="vpnStatus.regions && vpnStatus.regions.length > 0">
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <span class="font-medium">Regions:</span>
                                <div class="mt-1 space-y-1">
                                    <template x-for="region in vpnStatus.regions" :key="region">
                                        <div class="text-xs" x-text="region"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Tailscale Status Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tailscale Status</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="tailscaleStatus.running ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="tailscaleStatus.running ? 'Running' : 'Not Running'"></span>
                        </div>
                        <div x-show="tailscaleStatus.hostname" class="text-sm text-gray-600 dark:text-gray-400">
                            <span class="font-medium">Hostname:</span> <span x-text="tailscaleStatus.hostname"></span>
                        </div>
                    </div>
                </div>

                <!-- System Health Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Health</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="systemHealth.healthy ? 'bg-green-500' : 'bg-yellow-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="systemHealth.healthy ? 'Healthy' : 'Issues Detected'"></span>
                        </div>
                        <template x-for="message in systemHealth.messages" :key="message">
                            <div class="text-xs text-gray-600 dark:text-gray-400" x-text="message"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Device List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tailscale Devices</h2>
                <div class="overflow-visible">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider w-8"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Device</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">IP Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">OS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Region</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Route via PIA</th>
                            </tr>
                        </thead>
                        <template x-for="device in devices" :key="device.id">
                            <tbody class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                                <!-- Main device row -->
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-2 py-4 whitespace-nowrap">
                                        <button @click="toggleDeviceExpanded(device.id)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                            <svg x-show="!expandedDevices.includes(device.id)" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                            <svg x-show="expandedDevices.includes(device.id)" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="device.hostname"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-600 dark:text-gray-400" x-text="device.ip_addresses.join(', ')"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-600 dark:text-gray-400" x-text="device.os || 'Unknown'"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="device.online ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'" class="px-2 py-1 text-xs rounded-full" x-text="device.online ? 'Online' : 'Offline'"></span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <!-- Region selector for all devices -->
                                        <select
                                            @change="setDeviceRegion(device.id, $event.target.value)"
                                            class="text-sm rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- Select region --</option>
                                            <template x-for="region in regions" :key="region.id">
                                                <option :value="region.id" :selected="device.region_id === region.id" x-text="`${region.name} (${region.country})`"></option>
                                            </template>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <!-- Toggle only for servers (Linux/headless) -->
                                        <template x-if="!device.auto_managed">
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    :checked="device.routing_enabled"
                                                    @change="toggleDeviceRouting(device.id, $event.target.checked)"
                                                    class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 dark:after:border-gray-600 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 dark:peer-checked:bg-blue-500"></div>
                                            </label>
                                        </template>
                                        <!-- Show auto status for GUI devices -->
                                        <template x-if="device.auto_managed">
                                            <span :class="device.routing_enabled ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'" class="text-sm font-medium" x-text="device.routing_enabled ? 'Enabled' : 'Disabled'"></span>
                                        </template>
                                    </td>
                                </tr>
                                <!-- Expandable detail row -->
                                <tr x-show="expandedDevices.includes(device.id)" class="bg-gray-50 dark:bg-gray-700">
                                    <td colspan="7" class="px-8 py-4">
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="font-medium text-gray-700 dark:text-gray-300">VPN Interface:</span>
                                                <span class="ml-2 text-gray-600 dark:text-gray-400" x-text="device.routing_enabled && device.region_id ? `pia-${device.region_id}` : 'Not connected'"></span>
                                            </div>
                                            <div>
                                                <span class="font-medium text-gray-700 dark:text-gray-300">VPN Status:</span>
                                                <span class="ml-2" :class="device.routing_enabled ? 'text-green-600 dark:text-green-400' : 'text-gray-600 dark:text-gray-400'" x-text="device.routing_enabled ? 'Connected' : 'Disconnected'"></span>
                                            </div>
                                            <div>
                                                <span class="font-medium text-gray-700 dark:text-gray-300">Public IP:</span>
                                                <span class="ml-2 text-gray-600 dark:text-gray-400">Loading...</span>
                                            </div>
                                            <div>
                                                <span class="font-medium text-gray-700 dark:text-gray-300">Last Handshake:</span>
                                                <span class="ml-2 text-gray-600 dark:text-gray-400">N/A</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                    <div x-show="devices.length === 0" class="text-center py-4 text-gray-500 dark:text-gray-400">
                        No devices found
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function app() {
            return {
                loading: false,
                piaStatus: { connected: false, region_name: null, ip_address: null },
                vpnStatus: { active_count: 0, regions: [] },
                tailscaleStatus: { running: false, exit_node_enabled: false, hostname: null },
                systemHealth: { healthy: false, messages: [] },
                regions: [],
                selectedRegion: '',
                devices: [],
                expandedDevices: [],
                pollInterval: null,

                async init() {
                    await this.loadRegions();
                    await this.refreshStatus();

                    // Poll status every 5 seconds
                    this.pollInterval = setInterval(() => this.refreshStatus(), 5000);
                },

                async loadRegions() {
                    try {
                        const response = await fetch('/api/settings/regions');
                        const data = await response.json();
                        this.regions = data.regions;
                    } catch (error) {
                        console.error('Failed to load regions:', error);
                    }
                },

                async refreshStatus() {
                    await Promise.all([
                        this.loadPIAStatus(),
                        this.loadVPNStatus(),
                        this.loadTailscaleStatus(),
                        this.loadSystemHealth(),
                        this.loadDevices()
                    ]);
                },

                async loadPIAStatus() {
                    try {
                        const response = await fetch('/api/status/pia');
                        this.piaStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load PIA status:', error);
                    }
                },

                async loadVPNStatus() {
                    try {
                        const response = await fetch('/api/status/vpn');
                        this.vpnStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load VPN status:', error);
                        // Fallback to single connection count if endpoint doesn't exist
                        this.vpnStatus = {
                            active_count: this.piaStatus.connected ? 1 : 0,
                            regions: this.piaStatus.connected && this.piaStatus.region_name ? [this.piaStatus.region_name] : []
                        };
                    }
                },

                async loadTailscaleStatus() {
                    try {
                        const response = await fetch('/api/status/tailscale');
                        this.tailscaleStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load Tailscale status:', error);
                    }
                },

                async loadSystemHealth() {
                    try {
                        const response = await fetch('/api/status/health');
                        this.systemHealth = await response.json();
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                    }
                },

                async loadDevices() {
                    try {
                        const response = await fetch('/api/devices');
                        const data = await response.json();
                        this.devices = data.devices;
                    } catch (error) {
                        console.error('Failed to load devices:', error);
                    }
                },

                async toggleDeviceRouting(deviceId, enabled) {
                    try {
                        const response = await fetch(`/api/devices/${deviceId}/toggle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert('Failed to toggle device routing: ' + error.detail);
                            await this.loadDevices(); // Reload to reset checkbox
                        } else {
                            await this.loadDevices();
                        }
                    } catch (error) {
                        alert('Failed to toggle device routing: ' + error.message);
                        await this.loadDevices(); // Reload to reset checkbox
                    }
                },

                async setDeviceRegion(deviceId, regionId) {
                    if (!regionId) return; // Don't do anything if no region selected

                    try {
                        const response = await fetch(`/api/devices/${deviceId}/region`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ region_id: regionId })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert('Failed to set device region: ' + error.detail);
                            await this.loadDevices(); // Reload to reset selector
                        } else {
                            const data = await response.json();
                            await this.loadDevices();
                            await this.loadVPNStatus(); // Refresh VPN status to show new region
                            // Show message briefly if it contains exit node instructions
                            if (data.message && data.message.includes('Tailscale app')) {
                                console.log('âœ“ ' + data.message);
                            }
                        }
                    } catch (error) {
                        alert('Failed to set device region: ' + error.message);
                        await this.loadDevices(); // Reload to reset selector
                    }
                },

                toggleDeviceExpanded(deviceId) {
                    const index = this.expandedDevices.indexOf(deviceId);
                    if (index > -1) {
                        this.expandedDevices.splice(index, 1);
                    } else {
                        this.expandedDevices.push(deviceId);
                    }
                }
            }
        }
    </script>
</body>
</html>
