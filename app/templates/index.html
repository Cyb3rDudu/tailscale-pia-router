<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailscale PIA Router</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media'
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900" x-data="app()" x-init="init()">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Tailscale PIA Router</h1>
                    <a href="/settings" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Settings</a>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- VPN Connections Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">VPN Connections</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="vpnStatus.active_count > 0 ? 'bg-green-500' : 'bg-gray-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="vpnStatus.active_count > 0 ? `${vpnStatus.active_count} active connection${vpnStatus.active_count > 1 ? 's' : ''}` : 'No active connections'"></span>
                        </div>
                        <template x-if="vpnStatus.connections && vpnStatus.connections.length > 0">
                            <div class="mt-3 space-y-3">
                                <template x-for="conn in vpnStatus.connections" :key="conn.region_id">
                                    <div class="text-sm border-l-2 border-blue-500 pl-3 py-1">
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="conn.region_name"></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1 space-y-0.5">
                                            <div>
                                                <span class="font-medium">Interface:</span>
                                                <span x-text="conn.interface"></span>
                                            </div>
                                            <div>
                                                <span class="font-medium">Last Handshake:</span>
                                                <span x-text="conn.last_handshake || 'N/A'"></span>
                                            </div>
                                            <template x-if="conn.transfer_rx && conn.transfer_tx">
                                                <div>
                                                    <span class="font-medium">Transfer:</span>
                                                    <span x-text="`↓ ${conn.transfer_rx}, ↑ ${conn.transfer_tx}`"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Tailscale Status Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tailscale Status</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="tailscaleStatus.running ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="tailscaleStatus.running ? 'Running' : 'Not Running'"></span>
                        </div>
                        <div x-show="tailscaleStatus.hostname" class="text-sm text-gray-600 dark:text-gray-400">
                            <span class="font-medium">Hostname:</span> <span x-text="tailscaleStatus.hostname"></span>
                        </div>
                    </div>
                </div>

                <!-- System Health Card -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Health</h2>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div :class="systemHealth.healthy ? 'bg-green-500' : 'bg-yellow-500'" class="w-3 h-3 rounded-full mr-2"></div>
                            <span class="text-sm dark:text-gray-200" x-text="systemHealth.healthy ? 'Healthy' : 'Issues Detected'"></span>
                        </div>
                        <template x-for="message in systemHealth.messages" :key="message">
                            <div class="text-xs text-gray-600 dark:text-gray-400" x-text="message"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Device List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tailscale Devices</h2>
                <div class="overflow-visible">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Device</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">IP Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">OS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">VPN Region</th>
                            </tr>
                        </thead>
                        <template x-for="device in devices" :key="device.id">
                            <tbody class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                                <!-- Main device row -->
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="device.hostname"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-600 dark:text-gray-400" x-text="device.ip_addresses.join(', ')"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-600 dark:text-gray-400" x-text="device.os || 'Unknown'"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="device.online ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'" class="px-2 py-1 text-xs rounded-full" x-text="device.online ? 'Online' : 'Offline'"></span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <!-- Region selector for all devices. Setting region enables routing, clearing disables it. -->
                                        <select
                                            @change="setDeviceRegion(device.id, $event.target.value)"
                                            class="text-sm rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- No VPN --</option>
                                            <template x-for="region in regions" :key="region.id">
                                                <option :value="region.id" :selected="device.region_id === region.id" x-text="`${region.name} (${region.country})`"></option>
                                            </template>
                                        </select>
                                        <!-- Show routing status indicator -->
                                        <div x-show="device.region_id" class="mt-1 text-xs" :class="device.routing_enabled ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'">
                                            <span x-text="device.routing_enabled ? '✓ Routing enabled' : '⏳ Connecting...'"></span>
                                            <span x-show="device.auto_managed" class="ml-1 text-gray-500 dark:text-gray-400">(Set exit node in Tailscale app)</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                    <div x-show="devices.length === 0" class="text-center py-4 text-gray-500 dark:text-gray-400">
                        No devices found
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function app() {
            return {
                loading: false,
                piaStatus: { connected: false, region_name: null, ip_address: null },
                vpnStatus: { active_count: 0, connections: [] },
                tailscaleStatus: { running: false, exit_node_enabled: false, hostname: null },
                systemHealth: { healthy: false, messages: [] },
                regions: [],
                selectedRegion: '',
                devices: [],
                expandedDevices: [],
                pollInterval: null,

                async init() {
                    await this.loadRegions();
                    await this.refreshStatus();

                    // Poll status every 5 seconds
                    this.pollInterval = setInterval(() => this.refreshStatus(), 5000);
                },

                async loadRegions() {
                    try {
                        const response = await fetch('/api/settings/regions');
                        const data = await response.json();
                        this.regions = data.regions;
                    } catch (error) {
                        console.error('Failed to load regions:', error);
                    }
                },

                async refreshStatus() {
                    await Promise.all([
                        this.loadPIAStatus(),
                        this.loadVPNStatus(),
                        this.loadTailscaleStatus(),
                        this.loadSystemHealth(),
                        this.loadDevices()
                    ]);
                },

                async loadPIAStatus() {
                    try {
                        const response = await fetch('/api/status/pia');
                        this.piaStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load PIA status:', error);
                    }
                },

                async loadVPNStatus() {
                    try {
                        const response = await fetch('/api/status/vpn');
                        this.vpnStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load VPN status:', error);
                        // Fallback to empty connections if endpoint fails
                        this.vpnStatus = {
                            active_count: 0,
                            connections: []
                        };
                    }
                },

                async loadTailscaleStatus() {
                    try {
                        const response = await fetch('/api/status/tailscale');
                        this.tailscaleStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load Tailscale status:', error);
                    }
                },

                async loadSystemHealth() {
                    try {
                        const response = await fetch('/api/status/health');
                        this.systemHealth = await response.json();
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                    }
                },

                async loadDevices() {
                    try {
                        const response = await fetch('/api/devices');
                        const data = await response.json();
                        this.devices = data.devices;
                    } catch (error) {
                        console.error('Failed to load devices:', error);
                    }
                },

                async setDeviceRegion(deviceId, regionId) {
                    // Allow empty regionId to clear region selection
                    // Empty/null regionId will disable routing and clean up VPN if unused

                    try {
                        const response = await fetch(`/api/devices/${deviceId}/region`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ region_id: regionId || null })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert('Failed to set device region: ' + error.detail);
                            await this.loadDevices(); // Reload to reset selector
                        } else {
                            const data = await response.json();
                            await this.loadDevices();
                            await this.loadVPNStatus(); // Refresh VPN status to show new region
                            // Show message with exit node instructions
                            if (data.message) {
                                console.log('✓ ' + data.message);
                            }
                        }
                    } catch (error) {
                        alert('Failed to set device region: ' + error.message);
                        await this.loadDevices(); // Reload to reset selector
                    }
                },

                toggleDeviceExpanded(deviceId) {
                    const index = this.expandedDevices.indexOf(deviceId);
                    if (index > -1) {
                        this.expandedDevices.splice(index, 1);
                    } else {
                        this.expandedDevices.push(deviceId);
                    }
                }
            }
        }
    </script>
</body>
</html>
