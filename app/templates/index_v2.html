<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIA Router - Topology View</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Prevent scrolling on main viewport */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* Graph styles */
        .network-link-mesh {
            stroke: #475569;
            stroke-width: 1;
            stroke-dasharray: 4 4;
            fill: none;
            opacity: 0.4;
        }
        .network-link-vpn {
            stroke: #3b82f6;
            stroke-width: 2;
            fill: none;
            opacity: 0.8;
        }
        .network-link-vpn.animated {
            stroke-dasharray: 5 5;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }
        .network-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .network-node:hover {
            filter: brightness(1.2);
        }
        .network-node.selected {
            filter: brightness(1.3);
        }

        /* Device table styles */
        .device-table {
            font-size: 14px;
        }
        .device-row {
            height: 40px;
            transition: background-color 0.2s ease;
        }
        .device-row:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .device-row.selected {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Endpoint pill styles */
        .endpoint-pill {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .endpoint-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .endpoint-pill.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        /* Compact status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Graph container */
        #topology-graph {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 8px;
        }

        /* Custom scrollbar for device table */
        .device-table-container::-webkit-scrollbar {
            width: 6px;
        }
        .device-table-container::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .device-table-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100" x-data="app()" x-init="init()">
    <!-- Header (60px) -->
    <header class="bg-slate-800 border-b border-slate-700 px-6 py-3">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold text-white">PIA Router - Topology View</h1>
            <div class="flex items-center space-x-6">
                <!-- Compact Status Indicators -->
                <div class="flex items-center space-x-2">
                    <div :class="vpnStatus.active_count > 0 ? 'bg-green-500' : 'bg-slate-500'" class="status-dot"></div>
                    <span class="text-sm text-slate-300"><span x-text="vpnStatus.active_count"></span> VPN</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div :class="tailscaleStatus.running ? 'bg-green-500' : 'bg-red-500'" class="status-dot"></div>
                    <span class="text-sm text-slate-300">Tailscale</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div :class="systemHealth.healthy ? 'bg-green-500' : 'bg-yellow-500'" class="status-dot"></div>
                    <span class="text-sm text-slate-300">System</span>
                </div>
                <a href="/settings" class="text-blue-400 hover:text-blue-300 text-sm font-medium">Settings</a>
                <a href="/" class="text-slate-400 hover:text-slate-300 text-sm">Classic View</a>
            </div>
        </div>
    </header>

    <!-- Endpoint Pills (80px) -->
    <div class="bg-slate-800 border-b border-slate-700 px-6 py-3">
        <div class="flex items-center space-x-3 overflow-x-auto">
            <span class="text-sm text-slate-400 flex-shrink-0">Active Endpoints:</span>
            <template x-for="conn in vpnStatus.connections" :key="conn.region_id">
                <div
                    class="endpoint-pill flex items-center space-x-3 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 flex-shrink-0"
                    :class="selectedEndpoint === conn.region_id ? 'active' : ''"
                    @click="toggleEndpointFilter(conn.region_id)">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="font-medium text-white" x-text="conn.region_name"></span>
                    <span class="text-slate-400 text-sm">
                        <span x-text="devices.filter(d => d.region_id === conn.region_id && d.routing_enabled).length"></span> devices
                    </span>
                </div>
            </template>
            <div x-show="vpnStatus.connections.length === 0" class="text-slate-500 text-sm">No active VPN connections</div>
        </div>
    </div>

    <!-- Main Content: Split View (Graph 60% + Table 40%) -->
    <main class="px-6 py-4" style="height: calc(100vh - 140px);">
        <div class="flex space-x-4 h-full">
            <!-- LEFT: Topology Graph (60% width) -->
            <div class="w-3/5 flex-shrink-0">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 h-full flex flex-col">
                    <h2 class="text-lg font-semibold text-white mb-3">Network Topology</h2>
                    <div id="topology-graph" class="flex-1 min-h-0"></div>
                </div>
            </div>

            <!-- RIGHT: Device Routing Table (40% width) -->
            <div class="w-2/5 flex-shrink-0">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-white">Device Routing</h2>
                        <span class="text-sm text-slate-400"><span x-text="devices.length"></span> devices</span>
                    </div>

                    <!-- Scrollable table container -->
                    <div class="device-table-container flex-1 min-h-0 overflow-y-auto">
                        <table class="device-table w-full">
                            <thead class="sticky top-0 bg-slate-700 text-slate-300 text-xs uppercase">
                                <tr>
                                    <th class="px-3 py-2 text-left">Device</th>
                                    <th class="px-3 py-2 text-left">IP</th>
                                    <th class="px-3 py-2 text-left">Region</th>
                                    <th class="px-3 py-2 text-center">Route</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="device in filteredDevices" :key="device.id">
                                    <tr
                                        class="device-row border-b border-slate-700"
                                        :class="selectedDevice === device.id ? 'selected' : ''"
                                        @click="selectDevice(device.id)">
                                        <td class="px-3 py-2">
                                            <div class="flex items-center space-x-2">
                                                <div :class="device.online ? 'bg-green-500' : 'bg-slate-500'" class="w-2 h-2 rounded-full"></div>
                                                <span class="font-medium text-white truncate" x-text="device.hostname"></span>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 text-slate-400 text-sm" x-text="device.ip_addresses[0]"></td>
                                        <td class="px-3 py-2">
                                            <select
                                                @click.stop
                                                @change="setDeviceRegion(device.id, $event.target.value)"
                                                class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white w-full"
                                                :value="device.region_id || ''">
                                                <option value="">No VPN</option>
                                                <template x-for="region in regions" :key="region.id">
                                                    <option :value="region.id" x-text="`${region.name} (${region.country})`"></option>
                                                </template>
                                            </select>
                                        </td>
                                        <td class="px-3 py-2 text-center">
                                            <button
                                                @click.stop="toggleDeviceRouting(device.id)"
                                                :disabled="!device.region_id"
                                                class="w-8 h-8 rounded-full transition-colors"
                                                :class="device.routing_enabled ? 'bg-red-600 hover:bg-red-700' : (device.region_id ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-600 cursor-not-allowed')"
                                                :title="device.routing_enabled ? 'Stop routing' : (device.region_id ? 'Start routing' : 'Select region first')">
                                                <!-- Play Icon -->
                                                <svg x-show="!device.routing_enabled" class="w-4 h-4 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                                <!-- Stop Icon -->
                                                <svg x-show="device.routing_enabled" class="w-4 h-4 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M6 6h12v12H6z"/>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div x-show="devices.length === 0" class="text-center py-8 text-slate-500">
                            No devices found
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function app() {
            return {
                loading: false,
                vpnStatus: { active_count: 0, connections: [] },
                tailscaleStatus: { running: false, exit_node_enabled: false, hostname: null },
                systemHealth: { healthy: false, messages: [] },
                regions: [],
                devices: [],
                selectedEndpoint: null,
                selectedDevice: null,
                pollInterval: null,
                networkGraph: null,

                get filteredDevices() {
                    if (!this.selectedEndpoint) return this.devices;
                    return this.devices.filter(d => d.region_id === this.selectedEndpoint);
                },

                async init() {
                    await this.loadRegions();
                    await this.refreshStatus();
                    this.initTopologyGraph();

                    // Poll status every 5 seconds
                    this.pollInterval = setInterval(() => {
                        this.refreshStatus();
                    }, 5000);
                },

                async loadRegions() {
                    try {
                        const response = await fetch('/api/settings/regions');
                        const data = await response.json();
                        this.regions = data.regions;
                    } catch (error) {
                        console.error('Failed to load regions:', error);
                    }
                },

                async refreshStatus() {
                    await Promise.all([
                        this.loadVPNStatus(),
                        this.loadTailscaleStatus(),
                        this.loadSystemHealth(),
                        this.loadDevices()
                    ]);

                    this.$nextTick(() => {
                        this.updateTopologyGraph();
                    });
                },

                async loadVPNStatus() {
                    try {
                        const response = await fetch('/api/status/vpn');
                        this.vpnStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load VPN status:', error);
                        this.vpnStatus = { active_count: 0, connections: [] };
                    }
                },

                async loadTailscaleStatus() {
                    try {
                        const response = await fetch('/api/status/tailscale');
                        this.tailscaleStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load Tailscale status:', error);
                    }
                },

                async loadSystemHealth() {
                    try {
                        const response = await fetch('/api/status/health');
                        this.systemHealth = await response.json();
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                    }
                },

                async loadDevices() {
                    try {
                        const response = await fetch('/api/devices');
                        const data = await response.json();
                        this.devices = data.devices;
                    } catch (error) {
                        console.error('Failed to load devices:', error);
                    }
                },

                async setDeviceRegion(deviceId, regionId) {
                    try {
                        const response = await fetch(`/api/devices/${deviceId}/region`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ region_id: regionId || null })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert('Failed to set device region: ' + error.detail);
                        }

                        await this.loadDevices();
                        await this.loadVPNStatus();
                    } catch (error) {
                        alert('Failed to set device region: ' + error.message);
                    }
                },

                async toggleDeviceRouting(deviceId) {
                    try {
                        const response = await fetch(`/api/devices/${deviceId}/toggle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert('Failed to toggle device routing: ' + error.detail);
                        }

                        await this.loadDevices();
                        await this.loadVPNStatus();
                    } catch (error) {
                        alert('Failed to toggle device routing: ' + error.message);
                    }
                },

                toggleEndpointFilter(regionId) {
                    if (this.selectedEndpoint === regionId) {
                        this.selectedEndpoint = null;
                    } else {
                        this.selectedEndpoint = regionId;
                    }
                    this.$nextTick(() => {
                        this.updateTopologyGraph();
                    });
                },

                selectDevice(deviceId) {
                    if (this.selectedDevice === deviceId) {
                        this.selectedDevice = null;
                    } else {
                        this.selectedDevice = deviceId;
                    }
                    this.$nextTick(() => {
                        this.updateTopologyGraph();
                    });
                },

                initTopologyGraph() {
                    const container = document.getElementById('topology-graph');
                    if (!container) return;

                    const width = container.clientWidth;
                    const height = container.clientHeight;

                    // Clear any existing SVG
                    d3.select('#topology-graph').selectAll('svg').remove();

                    // Create SVG
                    const svg = d3.select('#topology-graph')
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height)
                        .attr('viewBox', [0, 0, width, height]);

                    // Create groups for links and nodes
                    const linkGroup = svg.append('g').attr('class', 'links');
                    const nodeGroup = svg.append('g').attr('class', 'nodes');

                    this.networkGraph = { svg, linkGroup, nodeGroup, width, height };
                },

                updateTopologyGraph() {
                    if (!this.networkGraph) return;

                    const { svg, linkGroup, nodeGroup, width, height } = this.networkGraph;

                    // Build graph data with FIXED positions
                    const nodes = [];
                    const links = [];
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const meshRadius = Math.min(width, height) * 0.3;

                    // Position PIA exit nodes on left and right
                    const piaNodes = {};
                    const leftPiaNodes = [];
                    const rightPiaNodes = [];

                    this.vpnStatus.connections.forEach((conn, idx) => {
                        const nodeId = `pia-${conn.region_id}`;
                        const isLeft = idx % 2 === 0;
                        const side = isLeft ? leftPiaNodes : rightPiaNodes;

                        const piaNode = {
                            id: nodeId,
                            label: conn.region_name,
                            type: 'pia',
                            region_id: conn.region_id,
                            isLeft: isLeft,
                            sideIndex: side.length
                        };

                        side.push(piaNode);
                        nodes.push(piaNode);
                        piaNodes[conn.region_id] = piaNode;
                    });

                    // Position left PIA nodes
                    leftPiaNodes.forEach((node, idx) => {
                        node.x = 80;
                        node.y = centerY + (idx - (leftPiaNodes.length - 1) / 2) * 80;
                    });

                    // Position right PIA nodes
                    rightPiaNodes.forEach((node, idx) => {
                        node.x = width - 80;
                        node.y = centerY + (idx - (rightPiaNodes.length - 1) / 2) * 80;
                    });

                    // Order devices intelligently
                    const leftSideDevices = [];
                    const rightSideDevices = [];
                    const unroutedDevices = [];

                    this.devices.forEach(device => {
                        if (device.region_id && piaNodes[device.region_id]) {
                            const piaNode = piaNodes[device.region_id];
                            if (piaNode.isLeft) {
                                leftSideDevices.push(device);
                            } else {
                                rightSideDevices.push(device);
                            }
                        } else {
                            unroutedDevices.push(device);
                        }
                    });

                    const orderedDevices = [...leftSideDevices, ...unroutedDevices, ...rightSideDevices];

                    // Position devices in a ring
                    const deviceCount = orderedDevices.length;
                    orderedDevices.forEach((device, idx) => {
                        const angle = (idx / deviceCount) * 2 * Math.PI - Math.PI / 2;

                        nodes.push({
                            id: `device-${device.id}`,
                            label: device.hostname,
                            type: 'device',
                            online: device.online,
                            region_id: device.region_id,
                            device_id: device.id,
                            routing_enabled: device.routing_enabled,
                            x: centerX + meshRadius * Math.cos(angle),
                            y: centerY + meshRadius * Math.sin(angle)
                        });
                    });

                    // Add VPN connections (render first, behind mesh)
                    const deviceNodes = nodes.filter(n => n.type === 'device');
                    deviceNodes.forEach(deviceNode => {
                        if (deviceNode.region_id && deviceNode.routing_enabled) {
                            const piaNode = piaNodes[deviceNode.region_id];
                            if (piaNode) {
                                links.push({
                                    source: deviceNode,
                                    target: piaNode,
                                    type: 'vpn'
                                });
                            }
                        }
                    });

                    // Add mesh connections (render last, on top)
                    for (let i = 0; i < deviceNodes.length; i++) {
                        for (let j = i + 1; j < deviceNodes.length; j++) {
                            links.push({
                                source: deviceNodes[i],
                                target: deviceNodes[j],
                                type: 'mesh'
                            });
                        }
                    }

                    // Update links
                    const link = linkGroup.selectAll('line')
                        .data(links, d => `${d.source.id}-${d.target.id}`);

                    link.exit().remove();

                    const linkEnter = link.enter()
                        .append('line')
                        .attr('class', d => d.type === 'mesh' ? 'network-link-mesh' : 'network-link-vpn animated');

                    linkEnter.merge(link)
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    // Update nodes
                    const node = nodeGroup.selectAll('g')
                        .data(nodes, d => d.id);

                    node.exit().remove();

                    const nodeEnter = node.enter()
                        .append('g')
                        .attr('class', 'network-node')
                        .on('click', (event, d) => {
                            if (d.type === 'device') {
                                this.selectDevice(d.device_id);
                            } else if (d.type === 'pia') {
                                this.toggleEndpointFilter(d.region_id);
                            }
                        });

                    nodeEnter.append('circle')
                        .attr('r', d => d.type === 'pia' ? 20 : 16);

                    nodeEnter.append('text')
                        .attr('dy', 30)
                        .attr('text-anchor', 'middle')
                        .attr('class', 'text-white')
                        .style('font-size', '10px')
                        .style('font-weight', '500');

                    const allNodes = nodeEnter.merge(node);

                    allNodes
                        .attr('transform', d => `translate(${d.x},${d.y})`)
                        .classed('selected', d => {
                            if (d.type === 'device') {
                                return this.selectedDevice === d.device_id ||
                                       (this.selectedEndpoint && d.region_id === this.selectedEndpoint);
                            } else if (d.type === 'pia') {
                                return this.selectedEndpoint === d.region_id;
                            }
                            return false;
                        });

                    allNodes.select('circle')
                        .attr('fill', d => {
                            if (d.type === 'pia') return '#22c55e';
                            return d.online ? '#3b82f6' : '#6b7280';
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 2);

                    allNodes.select('text')
                        .text(d => d.label.length > 12 ? d.label.substring(0, 12) + '...' : d.label);
                }
            }
        }
    </script>
</body>
</html>
