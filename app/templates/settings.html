<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Tailscale PIA Router</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media'
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900" x-data="settings()" x-init="init()">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h1>
                    <a href="/" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Back to Dashboard</a>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Success/Error Messages -->
            <div x-show="successMessage" x-transition class="mb-6 bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-200 px-4 py-3 rounded">
                <span x-text="successMessage"></span>
            </div>
            <div x-show="errorMessage" x-transition class="mb-6 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded">
                <span x-text="errorMessage"></span>
            </div>

            <!-- PIA Credentials -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">PIA Credentials</h2>
                <form @submit.prevent="savePIACredentials()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                            <input
                                type="text"
                                x-model="pia.username"
                                required
                                class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="PIA username (e.g., p1234567)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                            <input
                                type="password"
                                x-model="pia.password"
                                required
                                class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="PIA password">
                        </div>
                        <div x-show="pia.configured" class="text-sm text-green-600 dark:text-green-400">
                            PIA credentials are configured
                        </div>
                        <button
                            type="submit"
                            :disabled="loading"
                            class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-800 disabled:opacity-50">
                            <span x-text="loading ? 'Saving...' : 'Save PIA Credentials'"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tailscale API Key -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Tailscale API Key</h2>
                <form @submit.prevent="saveTailscaleAPIKey()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">API Key</label>
                            <input
                                type="password"
                                x-model="tailscale.api_key"
                                required
                                class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="tskey-api-...">
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                Get your API key from <a href="https://login.tailscale.com/admin/settings/keys" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Tailscale Admin Console</a>
                            </p>
                        </div>
                        <div x-show="tailscale.configured" class="text-sm text-green-600 dark:text-green-400">
                            Tailscale API key is configured
                        </div>
                        <button
                            type="submit"
                            :disabled="loading"
                            class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-md hover:bg-blue-700 dark:hover:bg-blue-800 disabled:opacity-50">
                            <span x-text="loading ? 'Saving...' : 'Save Tailscale API Key'"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Region Management -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">PIA Regions</h2>
                <div class="space-y-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        The PIA server list is automatically fetched when you first load regions. Click the button below to manually refresh the list.
                    </p>
                    <button
                        @click="refreshRegions()"
                        :disabled="loading"
                        class="px-4 py-2 bg-gray-600 dark:bg-gray-700 text-white rounded-md hover:bg-gray-700 dark:hover:bg-gray-800 disabled:opacity-50">
                        <span x-text="loading ? 'Refreshing...' : 'Refresh Region List'"></span>
                    </button>
                </div>
            </div>

            <!-- Connection Logs -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Recent Connection Logs</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Event</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Message</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-for="log in logs" :key="log.id">
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400" x-text="formatTimestamp(log.timestamp)"></td>
                                    <td class="px-4 py-2 text-sm text-gray-900 dark:text-white" x-text="log.event_type"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="log.status === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'" class="px-2 py-1 text-xs rounded-full" x-text="log.status"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400" x-text="log.message || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="logs.length === 0" class="text-center py-4 text-gray-500 dark:text-gray-400">
                        No logs yet
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div x-show="logsPagination.total > logsPagination.limit" class="mt-4 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Showing <span x-text="logsPagination.offset + 1"></span> to
                        <span x-text="Math.min(logsPagination.offset + logsPagination.limit, logsPagination.total)"></span> of
                        <span x-text="logsPagination.total"></span> entries
                    </div>
                    <div class="flex space-x-2">
                        <button
                            @click="previousPage()"
                            :disabled="logsPagination.offset === 0"
                            class="px-3 py-1 bg-gray-600 dark:bg-gray-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700 dark:hover:bg-gray-600">
                            Previous
                        </button>
                        <button
                            @click="nextPage()"
                            :disabled="logsPagination.offset + logsPagination.limit >= logsPagination.total"
                            class="px-3 py-1 bg-gray-600 dark:bg-gray-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700 dark:hover:bg-gray-600">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function settings() {
            return {
                loading: false,
                successMessage: '',
                errorMessage: '',
                pia: {
                    username: '',
                    password: '',
                    configured: false
                },
                tailscale: {
                    api_key: '',
                    configured: false
                },
                logs: [],
                logsPagination: {
                    total: 0,
                    limit: 20,
                    offset: 0
                },

                async init() {
                    await this.loadSettings();
                    await this.loadLogs();

                    // Refresh logs every 10 seconds
                    setInterval(() => this.loadLogs(), 10000);
                },

                async loadSettings() {
                    try {
                        const [piaResponse, tailscaleResponse] = await Promise.all([
                            fetch('/api/settings/pia'),
                            fetch('/api/settings/tailscale')
                        ]);

                        const piaData = await piaResponse.json();
                        const tailscaleData = await tailscaleResponse.json();

                        this.pia.configured = piaData.configured;
                        if (piaData.username) {
                            this.pia.username = piaData.username;
                        }

                        this.tailscale.configured = tailscaleData.configured;
                    } catch (error) {
                        console.error('Failed to load settings:', error);
                    }
                },

                async loadLogs() {
                    try {
                        const response = await fetch(`/api/status/logs?limit=${this.logsPagination.limit}&offset=${this.logsPagination.offset}`);
                        const data = await response.json();
                        this.logs = data.entries;
                        this.logsPagination.total = data.total;
                        this.logsPagination.limit = data.limit;
                        this.logsPagination.offset = data.offset;
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                    }
                },

                previousPage() {
                    if (this.logsPagination.offset > 0) {
                        this.logsPagination.offset = Math.max(0, this.logsPagination.offset - this.logsPagination.limit);
                        this.loadLogs();
                    }
                },

                nextPage() {
                    if (this.logsPagination.offset + this.logsPagination.limit < this.logsPagination.total) {
                        this.logsPagination.offset += this.logsPagination.limit;
                        this.loadLogs();
                    }
                },

                async savePIACredentials() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        const response = await fetch('/api/settings/pia', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: this.pia.username,
                                password: this.pia.password
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail);
                        }

                        this.successMessage = 'PIA credentials saved successfully';
                        this.pia.configured = true;
                        this.pia.password = '';
                        await this.loadLogs();
                    } catch (error) {
                        this.errorMessage = 'Failed to save PIA credentials: ' + error.message;
                    } finally {
                        this.loading = false;
                        setTimeout(() => {
                            this.successMessage = '';
                            this.errorMessage = '';
                        }, 5000);
                    }
                },

                async saveTailscaleAPIKey() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        const response = await fetch('/api/settings/tailscale', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                api_key: this.tailscale.api_key
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail);
                        }

                        this.successMessage = 'Tailscale API key saved successfully';
                        this.tailscale.configured = true;
                        this.tailscale.api_key = '';
                        await this.loadLogs();
                    } catch (error) {
                        this.errorMessage = 'Failed to save Tailscale API key: ' + error.message;
                    } finally {
                        this.loading = false;
                        setTimeout(() => {
                            this.successMessage = '';
                            this.errorMessage = '';
                        }, 5000);
                    }
                },

                async refreshRegions() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';

                    try {
                        const response = await fetch('/api/settings/regions/refresh', {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail);
                        }

                        const data = await response.json();
                        this.successMessage = data.message;
                    } catch (error) {
                        this.errorMessage = 'Failed to refresh regions: ' + error.message;
                    } finally {
                        this.loading = false;
                        setTimeout(() => {
                            this.successMessage = '';
                            this.errorMessage = '';
                        }, 5000);
                    }
                },

                formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                }
            }
        }
    </script>
</body>
</html>
